serialport = require 'serialport'
myparser = require 'parser'

class ComfoAir extends serialport.SerialPort

  #http://jsperf.com/bytearray-to-hex-string
  #http://jsperf.com/hex-string-to-bytearray
  #http://stackoverflow.com/questions/9499854/node-js-serialport-module-event-types
  fromHexStr: (str) ->
    parseInt str.slice(i, i+2), 16 for tmp, i in str by 2

  max: (n1, n2) ->
    n1 = parseInt n1, 10
    n2 = parseInt n2, 10
    n1 > n2 ? n1 : n2

  addFillerLeft: (number, filler, length) ->
    str = '' + number
    fillerArray = new Array(@max(length - str.length, 0) + 1)
    fillerArray.join(filler) + str

  toHexStr: (bytearray) ->
    result = (@addFillerLeft bytearray[i].toString(16).toUpperCase(), '0', 2 for tmp, i in bytearray)
    result.join('')

  constructor:  (device, baudrate =9600) ->
    @info = {}
    #console.log 'Hex 0x6A '+ @fromHexStr '6A'
    #console.log '15 in Hex '+ @toHexStr {106}
    #console.log 'Hex 0x0F '+ @toHexStr @fromHexStr '0F'
    #myparser = @parseout
    #myparser 'abc', 'abc'

    super device,
      baudrate: baudrate
      #parser: serialport.parsers.readline '\n'
      parser: myparser.readline '\n'

    @on 'open', () ->
      console.log 'open'
      @on 'data', (data) ->
        @emit 'temp', data

module.exports = ComfoAir



